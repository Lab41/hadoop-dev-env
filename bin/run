#!/bin/bash

set -e

ROOT=$(cd $(dirname "$0")/..; pwd)

hadoop_conf="$1"
shift

if [[ "$hadoop_conf" == "" ]]; then
    echo "please enter the config" 1>&2
    exit 1
fi

setup_cdh() {
    cdh_version="$1"
    case "$cdh_version" in
        cdh4.4.0)
            CHECKOUT_DIR=$ROOT/cdh/$cdh_version
            HADOOP_VERSION=hadoop-2.0.0-$cdh_version
            HBASE_VERSION=hbase-0.94.6-$cdh_version

            setup_hadoop
            setup_hbase
            ;;

        cdh5.0.0)
            CHECKOUT_DIR=$ROOT/cdh/$cdh_version
            HADOOP_VERSION=hadoop-2.3.0-$cdh_version
            HBASE_VERSION=hbase-0.96.1.1-$cdh_version
            SOLR_VERSION=solr-4.4.0-$cdh_version

            setup_hadoop
            setup_hbase
            ;;
        *)
            echo "unknown cdh version $cdh_version" 2>&1
            exit 1
            ;;
    esac
}

setup_hadoop() {
    export HADOOP_CONF_DIR=$ROOT/conf/$hadoop_conf/hadoop-conf
    export YARN_CONF_DIR=$ROOT/conf/$hadoop_conf/yarn-conf

    export HADOOP_PREFIX=$CHECKOUT_DIR/$HADOOP_VERSION
    export HADOOP_HOME=$HADOOP_PREFIX

    export PATH=$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$PATH
    export CLASSPATH=$CLASSPATH:$HADOOP_CONF_DIR
}

setup_hbase() {
    export HBASE_HOME=$CHECKOUT_DIR/$HBASE_VERSION

    export PATH=$HBASE_HOME/bin:$HBASE_HOME/sbin:$PATH
}

setup_solr() {
    export SOLR_ZK_ENSEMBLE="$1"
    export SOLR_HDFS_HOME="$2"

    export SOLR_HOME=$CHECKOUT_DIR/$SOLR_VERSION
}

setup_zookeeper() {
    export ZOOKEEPER_HOME=$CHECKOUT_DIR/$ZOOKEEPER_VERSION

    export PATH=$ZOOKEEPER_HOME/bin:$ZOOKEEPER_HOME/sbin:$PATH
}

case "$hadoop_conf" in
    local)
        setup_cdh cdh5.0.0
        setup_zookeeper localhost:2181
        setup_solr hdfs://localhost:8020/solr

        ;;

    pseudo)
        setup_cdh cdh5.0.0
        ;;

    vm)
        setup_cdh cdh5.0.0
        ;;

    mp)
        setup_cdh cdh4.4.0
        ;;

    fm)
        setup_cdh cdh5.0.0
        ;;

    *)
        echo "unknown config $hadoop_conf" 1>&2
        exit 1
        ;;
esac

if [[ "$1" == "" ]]; then
    echo "please specify a command to run" 1>&2
    exit 1
fi

exec "$@"
